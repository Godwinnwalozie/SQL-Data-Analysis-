-- merge the tables
CREATE OR REPLACE VIEW consol AS
SELECT
p1.customer_id, c1.first_name,c1.last_name,c1.email,s1.staff_id,s1.store_id,p1.amount, p1.payment_date,p1.payment_id  FROM 
customer c1
JOIN payment p1
ON c1.customer_id = p1.customer_id
JOIN staff s1
ON s1.store_id = c1.store_id
;

-- Find the customer with most transactions
SELECT distinct customer_id, first_name,last_name, count (payment_id) from consol
GROUP BY customer_id , first_name, last_name
order by count(payment_id) DESC 
;

-- find the customer with the highest spend
CREATE OR REPLACE VIEW worth AS
SELECT distinct customer_id,first_name, last_name, sum(amount) as gross from consol
GROUP BY customer_id, first_name, last_name
ORDER BY sum(amount) desc
;

-- Assign Premium status if amount > 100, and basic if < 100
CREATE OR REPLACE VIEW status as
SELECT
distinct customer_id, first_name, sum(amount) gross,
(CASE
WHEN sum(amount) >=100 THEN 'PREMIUM'
WHEN sum(amount) < 100 THEN 'BASIC'
ELSE 'NONE'
END) category

FROM consol
GROUP BY rollup (customer_id, first_name)
;



--drop view if exists consol cascade

-- COUNT OF STATUS ans total amount
SELECT category, count (category) ,sum(gross) from status
group by 
rollup (category)
;

-- create email with gmail
SELECT distinct customer_id ,first_name, last_name, lower (left(first_name,1)|| '.'||last_name||'@gmail.com') from consol
where first_name similar to '[BYRDE]%'

